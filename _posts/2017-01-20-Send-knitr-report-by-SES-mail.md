---
layout: post
title: Send knitr html report with embed base64 images by SES mail
date: 2017-01-20 16:27:31
disqus: y
share: y
categories: paas r aws ses
tags: paas aws ses r knitr mail
---

How to send knitr html report with embed base64 images by SES mail.

It's beautiful to breakfast with a daily report generated by R **(knitr)** and automatically execute by WAS EC2 and sent to my email via WAS SES completely formatted in HTML.

These steps only are a puzzle composition from other pages, the more important references are:

- [Sending Email with Amazon SES](http://docs.aws.amazon.com/ses/latest/DeveloperGuide/sending-email.html)
- [Send emails via Amazon SES with Bash and cURL](https://coderwall.com/p/3vqf2g/send-emails-via-amazon-ses-with-bash-and-curl)

## Pre-requisites
- AWS EC2 running
- AWS SES running
- R on EC2
- Install knitr on R EC2

```
install.packages("xlsx", lib="~/data/scripts/Rpackages/", dependencies = TRUE, repos='http://cran.us.r-project.org')
```

- An user with permissions over all SES (with AWS IAM)

## Generating html report with knitr
**knitr** and **markdwn** are awesome packages developed by Yihui Xie and others. Visit its CRAN repository

- [knitr: A General-Purpose Package for Dynamic Report Generation in R](https://cran.r-project.org/web/packages/knitr/index.html).
- [rmarkdown: Dynamic Documents for R](https://cran.r-project.org/web/packages/rmarkdown/index.html)

There are many sites to learn knitr and markdown. [R-Markdown and Knitr Tutorial](https://www.r-bloggers.com/r-markdown-and-knitr-tutorial-part-1/)

We need a \*.Rmd markdown file with R code to generate the html report.

For example: (report.Rmd)

```
---
title: "report"
author: "Mario Pisa"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

\```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(XML)
require(knitr)
options(width = 80)
\```

## report
Hey man!. Did you know this?
\```{r, include=FALSE}
x <- rnorm(20)
plot(x)
\```
```

We want to generate the report by command line, so we need a R file like this:
```
#!/usr/bin/env Rscript
library(rmarkdown)
rmarkdown::render("report.Rmd")
```

The output is a html file.

## AWS SES html mail with base64 images
Then clean the report.html with `xmllint` and read it with `cat`,  to get only all the body tag and send it!

```
#!/bin/bash

TO="Email To <to@gmail.com>"
FROM="Email From <from@gmail.com>"
SUBJECT="Hey SES"
MESSAGE="This work!"

date="$(date -R)"
priv_key="$AWS_SECRET_KEY"
access_key="$AWS_ACCESS_KEY"
signature="$(echo -n "$date" | openssl dgst -sha256 -hmac "$priv_key" -binary | base64 -w 0)"
auth_header="X-Amzn-Authorization: AWS3-HTTPS AWSAccessKeyId=$access_key, Algorithm=HmacSHA256, Signature=$signature"
endpoint="https://email.us-east-1.amazonaws.com/"

mime_version="MIME-Version: 1.0"

action="Action=SendEmail"
source="Source=$FROM"
to="Destination.ToAddresses.member.1=$TO"
subject="Message.Subject.Data=$SUBJECT"
xmllint --html --xpath "//body" report.html 2>/dev/null >> report2.html
message="Message.Body.Html.Data="$(cat report2.html)

curl -v -X POST -H "Date: $date" -H "$content_type" -H "$mime_version" -H "$auth_header" --data-urlencode "$message" --data-urlencode "$to" --data-urlencode "$source" --data-urlencode "$action" --data-urlencode "$subject" "$endpoint"
```

Voil√†!

---

<a href="https://github.com/mariope/apuntes" target="_blank" class="big-button gray">Get it on GitHub &hearts;</a>

---

### Want more?

Like it? [Tell me](http://twitter.com/mariodevelop){:target="_blank"}.<br/>
Problem? [Use GitHub Issues](https://github.com/mariope/apuntes/issues){:target="_blank"}.
